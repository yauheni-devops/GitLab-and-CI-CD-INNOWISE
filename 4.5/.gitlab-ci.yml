stages:
  - test
  - deploy_dev
  - deploy_staging
  - deploy_prod

# 1. Задача: Тесты и Линтеры
# Запускается ВСЕГДА (ветки, теги, MR)
run_tests:
  stage: test
  script:
    - echo "Running unit tests..."
    - echo "Running linters..."
  rules:
    - when: always

# 2. Задача: Деплой на DEV
# Автоматически, только для ветки develop
deploy_to_dev:
  stage: deploy_dev
  environment:
    name: dev
  script:
    - echo "Deploying to DEV environment..."
  rules:
    - if: '$CI_COMMIT_BRANCH == "develop"'

# 3. Задача: Деплой на STAGING
# Автоматически для веток release/... ИЛИ hotfix/...
deploy_to_staging:
  stage: deploy_staging
  environment:
    name: staging
  script:
    - echo "Deploying to STAGING environment..."
  rules:
    # Используем регулярное выражение (=~)
    # ^release\/.*$ означает "начинается с release/"
    - if: '$CI_COMMIT_BRANCH =~ /^release\/.*$/'
    - if: '$CI_COMMIT_BRANCH =~ /^hotfix\/.*$/'

# 4. Задача: Деплой на PRODUCTION
# Только если есть ТЕГ, только ВРУЧНУЮ. Не запускается на main.
deploy_to_production:
  stage: deploy_prod
  environment:
    name: production
  script:
    - echo "Deploying version $CI_COMMIT_TAG to PRODUCTION..."
  rules:
    # Переменная CI_COMMIT_TAG существует только когда создан тег.
    # В пайплайнах обычных веток (включая main) эта задача будет пропущена.
    - if: '$CI_COMMIT_TAG'
      when: manual