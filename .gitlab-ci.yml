image: python:3.10-slim

stages:
  - build
  - test
  - deploy

# Настройка кэша для pip (чтобы не качать пакеты каждый раз из интернета)
variables:
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"

cache:
  paths:
    - .cache/pip

# Задача 1: Установка зависимостей
build_job:
  stage: build
  script:
    - echo "Installing dependencies..."
    - python -m venv venv            # Создаем виртуальное окружение
    - source venv/bin/activate       # Активируем его
    - pip install -r requirements.txt
  artifacts:
    paths:
      - venv/                        # Передаем папку venv следующей стадии
    expire_in: 1 hour                # Артефакт удалится через час (экономим место)

# Задача 2: Запуск Unit-тестов
unit_test_job:
  stage: test
  script:
    - echo "Running unit tests..."
    - source venv/bin/activate       # Активируем окружение из артефакта build_job
    - pytest --junitxml=report.xml   # Запускаем тесты с генерацией XML отчета
  artifacts:
    when: always                     # Сохранять отчет даже если тесты упали
    paths:
      - report.xml                   # Сохраняем сам файл отчета
    reports:
      junit: report.xml              # Говорим GitLab, что это именно отчет тестов (для красивого UI)

# Оставим integration_test_job как заглушку, если хотите
integration_test_job:
  stage: test
  script:
    - echo "Running integration tests (placeholder)..."

deploy_to_prod:
  stage: deploy
  script:
    - echo "Starting deploy..."
    - echo "Deploying to $PROD_SERVER_IP..."
    - echo "Using token: $PROD_API_TOKEN"
  rules:
    - if: $CI_COMMIT_BRANCH == "main"